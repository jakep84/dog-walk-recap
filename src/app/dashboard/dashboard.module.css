// src/app/dashboard/page.tsx
"use client";

import React, { useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { collection, getDocs, orderBy, query } from "firebase/firestore";
import { db } from "../lib/firebase";
import styles from "./dashboard.module.css";

type WalkDoc = {
  id: string;
  dogs?: string;
  durationMinutes?: number;
  distanceMiles?: number;
  weatherSummary?: string;
  tempF?: number | null;
  amountDue?: number | null; // internal-only
  createdAt?: any; // Firestore Timestamp
};

function toDateSafe(ts: any): Date | null {
  try {
    if (!ts) return null;
    if (typeof ts?.toDate === "function") return ts.toDate();
  } catch {}
  return null;
}

// Most recent Friday 00:00 local time
function startOfPayWeek(now = new Date()): Date {
  const d = new Date(now);
  d.setHours(0, 0, 0, 0);
  const day = d.getDay(); // Sun=0 ... Fri=5
  const daysSinceFriday = (day - 5 + 7) % 7;
  d.setDate(d.getDate() - daysSinceFriday);
  return d;
}
function endOfPayWeek(start: Date): Date {
  const d = new Date(start);
  d.setDate(d.getDate() + 7);
  return d;
}
function fmtMoney(n: number) {
  return `$${n.toFixed(2)}`;
}
function fmtDate(d: Date) {
  return d.toLocaleDateString(undefined, { month: "short", day: "numeric" });
}
function fmtDateTime(d: Date) {
  return d.toLocaleString(undefined, {
    month: "short",
    day: "numeric",
    year: "numeric",
    hour: "numeric",
    minute: "2-digit",
  });
}
function dayKey(d: Date) {
  return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
}

export default function DashboardPage() {
  const [walks, setWalks] = useState<WalkDoc[]>([]);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState("");

  const [monthCursor, setMonthCursor] = useState(() => {
    const d = new Date();
    d.setDate(1);
    d.setHours(0, 0, 0, 0);
    return d;
  });

  useEffect(() => {
    let alive = true;

    async function load() {
      try {
        setLoading(true);
        setErr("");

        const qy = query(collection(db, "walks"), orderBy("createdAt", "desc"));
        const snap = await getDocs(qy);

        const out: WalkDoc[] = [];
        snap.forEach((docSnap) => {
          const data = docSnap.data() as any;
          out.push({ id: docSnap.id, ...data });
        });

        if (!alive) return;
        setWalks(out);
      } catch (e: any) {
        if (!alive) return;
        setErr(e?.message || "Failed to load walks.");
      } finally {
        if (alive) setLoading(false);
      }
    }

    load();
    return () => {
      alive = false;
    };
  }, []);

  const payStart = useMemo(() => startOfPayWeek(new Date()), []);
  const payEnd = useMemo(() => endOfPayWeek(payStart), [payStart]);

  const payWeekWalks = useMemo(() => {
    return walks.filter((w) => {
      const d = toDateSafe(w.createdAt);
      if (!d) return false;
      return d >= payStart && d < payEnd;
    });
  }, [walks, payStart, payEnd]);

  const payTotal = useMemo(() => {
    return payWeekWalks.reduce((sum, w) => sum + (Number(w.amountDue) || 0), 0);
  }, [payWeekWalks]);

  const calendar = useMemo(() => {
    const year = monthCursor.getFullYear();
    const month = monthCursor.getMonth();

    const first = new Date(year, month, 1);
    const last = new Date(year, month + 1, 0);

    const start = new Date(first);
    start.setDate(first.getDate() - first.getDay()); // Sunday

    const end = new Date(last);
    end.setDate(last.getDate() + (6 - last.getDay())); // Saturday

    const days: Date[] = [];
    const cur = new Date(start);
    cur.setHours(0, 0, 0, 0);
    while (cur <= end) {
      days.push(new Date(cur));
      cur.setDate(cur.getDate() + 1);
    }

    const byDay = new Map<string, { count: number; total: number }>();
    for (const w of walks) {
      const d = toDateSafe(w.createdAt);
      if (!d) continue;
      const k = dayKey(new Date(d.getFullYear(), d.getMonth(), d.getDate()));
      const agg = byDay.get(k) || { count: 0, total: 0 };
      agg.count += 1;
      agg.total += Number(w.amountDue) || 0;
      byDay.set(k, agg);
    }

    return { days, byDay, month, year };
  }, [monthCursor, walks]);

  const monthLabel = useMemo(() => {
    return monthCursor.toLocaleDateString(undefined, {
      month: "long",
      year: "numeric",
    });
  }, [monthCursor]);

  const recent = useMemo(() => walks.slice(0, 80), [walks]);

  if (loading) {
    return (
      <div className={styles.wrap}>
        <div className={styles.title}>SmartWalk Dashboard</div>
        <div className={styles.dim}>Loading…</div>
      </div>
    );
  }

  if (err) {
    return (
      <div className={styles.wrap}>
        <div className={styles.title}>SmartWalk Dashboard</div>
        <div className={styles.error}>Error: {err}</div>
      </div>
    );
  }

  return (
    <div className={styles.wrap}>
      <div className={styles.headerRow}>
        <div>
          <div className={styles.title}>SmartWalk Dashboard</div>
          <div className={styles.sub}>
            Pay week: <b>{fmtDate(payStart)}</b> → <b>{fmtDate(payEnd)}</b>
          </div>
        </div>

        <div className={styles.kpiCard}>
          <div className={styles.kpiLabel}>Earned this pay week</div>
          <div className={styles.kpiValue}>{fmtMoney(payTotal)}</div>
          <div className={styles.kpiSub}>Walks: {payWeekWalks.length}</div>
        </div>
      </div>

      <div className={styles.grid}>
        {/* Calendar */}
        <div className={styles.card}>
          <div className={styles.cardHeader}>
            <div className={styles.cardTitle}>Monthly Calendar</div>
            <div className={styles.monthNav}>
              <button
                className={styles.navBtn}
                onClick={() => {
                  const d = new Date(monthCursor);
                  d.setMonth(d.getMonth() - 1);
                  setMonthCursor(d);
                }}
              >
                ◀
              </button>
              <div className={styles.monthLabel}>{monthLabel}</div>
              <button
                className={styles.navBtn}
                onClick={() => {
                  const d = new Date(monthCursor);
                  d.setMonth(d.getMonth() + 1);
                  setMonthCursor(d);
                }}
              >
                ▶
              </button>
            </div>
          </div>

          <div className={styles.dowRow}>
            {["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].map((d) => (
              <div key={d} className={styles.dow}>
                {d}
              </div>
            ))}
          </div>

          <div className={styles.calGrid}>
            {calendar.days.map((d) => {
              const inMonth = d.getMonth() === calendar.month;
              const k = dayKey(d);
              const agg = calendar.byDay.get(k);

              return (
                <div
                  key={k}
                  className={`${styles.dayCell} ${!inMonth ? styles.outMonth : ""}`}
                >
                  <div className={styles.dayNum}>{d.getDate()}</div>
                  {agg ? (
                    <div className={styles.pill}>
                      <div>
                        <b>{agg.count}</b> walk{agg.count === 1 ? "" : "s"}
                      </div>
                      <div className={styles.pillMoney}>{fmtMoney(agg.total)}</div>
                    </div>
                  ) : (
                    <div style={{ height: 28 }} />
                  )}
                </div>
              );
            })}
          </div>
        </div>

        {/* Walk list */}
        <div className={styles.card}>
          <div className={styles.cardHeader}>
            <div className={styles.cardTitle}>All Walks</div>
            <div className={styles.dimSmall}>Tap a walk to open it</div>
          </div>

          <div className={styles.list}>
            {recent.map((w) => {
              const d = toDateSafe(w.createdAt);
              const when = d ? fmtDateTime(d) : "—";
              const due = Number(w.amountDue) || 0;

              return (
                <Link
                  key={w.id}
                  href={`/walk/${w.id}?admin=1`}
                  className={styles.rowLink}
                >
                  <div className={styles.rowLeft}>
                    <div className={styles.rowTitle}>
                      {w.dogs || "Walk"}{" "}
                      <span className={styles.rowWhen}>({when})</span>
                    </div>
                    <div className={styles.rowMeta}>
                      {w.durationMinutes ?? 0} min •{" "}
                      {(w.distanceMiles ?? 0).toFixed(2)} mi
                      {w.weatherSummary ? ` • ${w.weatherSummary}` : ""}
                    </div>
                  </div>

                  <div className={styles.rowRight}>
                    <div className={styles.money}>{fmtMoney(due)}</div>
                    <div className={styles.dimTiny}>earned</div>
                  </div>
                </Link>
              );
            })}

            {recent.length === 0 ? (
              <div className={styles.dim}>No walks yet.</div>
            ) : null}
          </div>
        </div>
      </div>
    </div>
  );
}
